name: Python Unit Test + Code Coverage

on:
  push:
    branches:
      - python/pre_release
  pull_request: {}

jobs:
  build-linux:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 5

    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync --no-install-project --all-extras

    - name: Lint with ruff
      run: |
        uv run ruff check
        uv run ruff format --check

    - name: Test with pytest
      run: |
        uv run pytest tests -v --cov --junitxml=pytest.xml --cov-report=term-missing:skip-covered | tee pytest-coverage.txt

    - name: Pytest coverage comment
      if: ${{ github.ref == 'refs/heads/python/pre_release' }}
      id: coverageComment
      uses: MishaKav/pytest-coverage-comment@v1.2.0
      with:
        default-branch: python/pre_release
        pytest-coverage-path: ./pytest-coverage.txt
        junitxml-path: ./pytest.xml

    - name: Update README with Coverage HTML
      if: ${{ github.ref == 'refs/heads/python/pre_release' }}
      env:
        COVERAGE_HTML: ${{ steps.coverageComment.outputs.coverageHtml }}
      run: |
        printf '%s\n' "$COVERAGE_HTML" > /tmp/coverage.html
        awk '
          /<!-- Pytest Coverage Comment:Begin -->/ {
            print
            while ((getline line < "/tmp/coverage.html") > 0) print line
            skip=1; next
          }
          /<!-- Pytest Coverage Comment:End -->/ { skip=0; print; next }
          !skip
        ' README.md > /tmp/README_updated.md && mv /tmp/README_updated.md README.md

    - name: Commit & Push changes to README
      if: ${{ github.ref == 'refs/heads/python/pre_release' }}
      uses: actions-js/push@v1.5
      with:
        branch: python/pre_release
        message: Update coverage in README [skip ci]
        github_token: ${{ secrets.GITHUB_TOKEN }}
